{% extends 'core/layout/_base.html' %}
{% load static %}

{% block title %}Itineraries - TRANSPERSO{% endblock %}

{% block body %}
  {% include 'core/partials/_navbar.html' %}
  
  <div class="container" style="max-width: 1200px; margin: 60px auto; padding: 0 20px;">
    <!-- Header with Create Buttons -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h2 style="font-size: 36px; font-weight: 900; margin: 0 0 0.5rem 0; color: var(--text-primary);">
          All Itineraries
        </h2>
        <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
          ğŸ“Š Stored in RDF Triplestore (Apache Jena Fuseki)
        </p>
      </div>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'itinerary:create' %}?type=Business" class="cta-hero" style="text-decoration: none; padding: 1rem 2rem; font-size: 14px; white-space: nowrap;">
          ğŸ’¼ Business Trip
        </a>
        <a href="{% url 'itinerary:create' %}?type=Leisure" class="cta-hero" style="text-decoration: none; padding: 1rem 2rem; font-size: 14px; white-space: nowrap;">
          ğŸ–ï¸ Leisure Trip
        </a>
        <a href="{% url 'itinerary:create' %}?type=Educational" class="cta-hero" style="text-decoration: none; padding: 1rem 2rem; font-size: 14px; white-space: nowrap;">
          ğŸ“ Educational Trip
        </a>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div style="margin-bottom: 2rem;">
        {% for message in messages %}
          <p class="{% if message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}" 
             style="padding: 1rem 1.5rem; border-radius: var(--radius); margin-bottom: 1rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;
                    {% if message.tags == 'error' %}background: #fee2e2; border: 1px solid #fecaca; color: #991b1b;
                    {% elif message.tags == 'warning' %}background: #fef3c7; border: 1px solid #fde68a; color: #92400e;
                    {% else %}background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af;{% endif %}">
            {% if message.tags == 'error' %}âŒ{% elif message.tags == 'warning' %}âš ï¸{% else %}âœ…{% endif %}
            {{ message }}
          </p>
        {% endfor %}
      </div>
    {% endif %}

    <!-- AI Query Console -->
    <div style="margin-bottom: 2rem; padding: 1rem; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: var(--radius-lg);">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
        <h3 style="margin: 0; font-weight: 800; color: var(--text-primary); font-size: 18px;">ğŸ¤– AI Query</h3>
        <div>
          <button id="aiRunBtn" class="cta-hero" type="button" style="padding: 0.6rem 1.2rem; font-size: 13px;">Run</button>
        </div>
      </div>
      <p style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 13px;">Ask in natural language (FR/EN). Examples: "List business trips under 1000", "Create leisure trip ..."</p>
      <!-- Suggested quick queries -->
      <div id="aiSuggestions" style="display: flex; flex-wrap: wrap; gap: .5rem; margin: .25rem 0 0.75rem 0;">
        <button type="button" class="ai-suggest" data-q="List business trips under 1000" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">List business < 1000</button>
        <button type="button" class="ai-suggest" data-q="List leisure trips planned" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">Leisure planned</button>
        <button type="button" class="ai-suggest" data-q="Create leisure trip with budget per day 120 group size 2 for 3 days" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">Create leisure sample</button>
        <button type="button" class="ai-suggest" data-q="Update itinerary I-B-002 status Completed" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">Set I-B-002 Completed</button>
        <button type="button" class="ai-suggest" data-q="Delete itinerary I-L-003" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">Delete I-L-003</button>
        <button type="button" class="ai-suggest" data-q="Show itineraries with duration over 5 days" style="padding: .3rem .7rem; border: 1px solid var(--border); border-radius: 999px; background: var(--bg-muted); color: var(--text-secondary); cursor: pointer;">Duration > 5</button>
      </div>
      <textarea id="aiQueryInput" rows="2" placeholder="Describe your query or CRUD action..." style="width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border); border-radius: var(--radius); resize: vertical; background: var(--bg-muted); color: var(--text-primary);"></textarea>
      <div id="aiResult" style="margin-top: 1rem; padding: 0.8rem 1rem; background: var(--bg-muted); border: 1px dashed var(--border); border-radius: var(--radius); color: var(--text-secondary); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space: pre-wrap; max-height: 320px; overflow: auto;"></div>
    </div>

    <!-- Itineraries Table -->
    {% if itineraries %}
      <div style="background: var(--bg-secondary); border: 2px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md);">
        <table style="width: 100%; margin: 0; border: none; box-shadow: none;">
          <thead>
            <tr>
              <th style="padding: 1.5rem 2rem; text-align: left; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                ID
              </th>
              <th style="padding: 1.5rem 2rem; text-align: left; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                TYPE
              </th>
              <th style="padding: 1.5rem 2rem; text-align: left; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                STATUS
              </th>
              <th style="padding: 1.5rem 2rem; text-align: left; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                COST (TND)
              </th>
              <th style="padding: 1.5rem 2rem; text-align: left; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                DURATION
              </th>
              <th style="padding: 1.5rem 2rem; text-align: center; background: linear-gradient(135deg, var(--text-primary), #374151); color: white; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
                ACTIONS
              </th>
            </tr>
          </thead>
          <tbody>
            {% for it in itineraries %}
              <tr style="border-bottom: 1px solid var(--border-light); transition: var(--transition);">
                <td style="padding: 1.4rem 2rem; font-weight: 600; color: var(--text-primary); font-size: 15px;">
                  {{ it.id|default:"N/A" }}
                </td>
                <td style="padding: 1.4rem 2rem; color: var(--text-secondary); font-size: 15px;">
                  <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 1rem; background: 
                    {% if it.type == 'Business' %}#dbeafe
                    {% elif it.type == 'Leisure' %}#d1fae5
                    {% elif it.type == 'Educational' %}#fef3c7
                    {% else %}#fee2e2{% endif %}; 
                    color: 
                    {% if it.type == 'Business' %}#1e40af
                    {% elif it.type == 'Leisure' %}#065f46
                    {% elif it.type == 'Educational' %}#92400e
                    {% else %}#991b1b{% endif %}; 
                    border-radius: 20px; font-weight: 600; font-size: 13px;">
                    {% if it.type == 'Business' %}ğŸ’¼{% elif it.type == 'Leisure' %}ğŸ–ï¸{% elif it.type == 'Educational' %}ğŸ“{% else %}ğŸ“‹{% endif %}
                    {{ it.type|default:"N/A" }}
                  </span>
                </td>
                <td style="padding: 1.4rem 2rem; color: var(--text-secondary); font-size: 15px;">
                  <span style="display: inline-block; padding: 0.4rem 1rem; background: 
                    {% if it.status == 'Completed' %}#d1fae5
                    {% elif it.status == 'InProgress' %}#fef3c7
                    {% elif it.status == 'Planned' %}#dbeafe
                    {% else %}#fee2e2{% endif %}; 
                    color: 
                    {% if it.status == 'Completed' %}#065f46
                    {% elif it.status == 'InProgress' %}#92400e
                    {% elif it.status == 'Planned' %}#1e40af
                    {% else %}#991b1b{% endif %}; 
                    border-radius: 20px; font-weight: 600; font-size: 13px;">
                    {{ it.status|default:"N/A" }}
                  </span>
                </td>
                <td style="padding: 1.4rem 2rem; color: var(--primary); font-weight: 700; font-size: 15px;">
                  {{ it.cost|default:"0.00" }}
                </td>
                <td style="padding: 1.4rem 2rem; color: var(--text-secondary); font-size: 15px;">
                  {{ it.duration|default:"0" }} days
                </td>
                <td style="padding: 1.4rem 2rem; text-align: center;">
                  <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    <a href="{% url 'itinerary:detail' it.id %}?s={{ it.subject|urlencode }}" 
                       style="text-decoration: none; display: inline-block; padding: 0.6rem 1.2rem; background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: var(--radius-full); font-weight: 600; font-size: 13px; transition: var(--transition);"
                       onmouseover="this.style.background='rgba(16, 185, 129, 0.1)'; this.style.transform='translateY(-2px)';"
                       onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)';">
                      ğŸ‘ï¸ View
                    </a>
                    <a href="{% url 'itinerary:update' it.id %}?s={{ it.subject|urlencode }}" 
                       style="text-decoration: none; display: inline-block; padding: 0.6rem 1.2rem; background: transparent; border: 2px solid var(--secondary); color: var(--secondary); border-radius: var(--radius-full); font-weight: 600; font-size: 13px; transition: var(--transition);"
                       onmouseover="this.style.background='rgba(6, 182, 212, 0.1)'; this.style.transform='translateY(-2px)';"
                       onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)';">
                      âœï¸ Edit
                    </a>
                    <a href="{% url 'itinerary:delete' it.id %}?s={{ it.subject|urlencode }}" 
                       style="text-decoration: none; display: inline-block; padding: 0.6rem 1.2rem; background: transparent; border: 2px solid #ef4444; color: #ef4444; border-radius: var(--radius-full); font-weight: 600; font-size: 13px; transition: var(--transition);"
                       onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.transform='translateY(-2px)';"
                       onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)';">
                      ğŸ—‘ï¸ Delete
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Stats Footer -->
      <div style="margin-top: 1.5rem; padding: 1rem 1.5rem; background: var(--bg-muted); border-radius: var(--radius); color: var(--text-secondary); font-size: 14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <span>
          <strong style="color: var(--text-primary);">Total:</strong> {{ itineraries|length }} itineraries in RDF store
        </span>
        {% if filters %}
        <span style="display: flex; align-items: center; gap: 0.5rem;">
          <strong>Filters applied</strong>
          <a href="{% url 'itinerary:list' %}" style="color: var(--primary); text-decoration: none; font-weight: 600;"
             onmouseover="this.style.textDecoration='underline';"
             onmouseout="this.style.textDecoration='none';">Clear</a>
        </span>
        {% endif %}
      </div>
    {% else %}
      <!-- Empty State -->
      <div style="text-align: center; padding: 5rem 2rem; background: var(--bg-secondary); border: 2px dashed var(--border); border-radius: var(--radius-lg);">
        <div style="font-size: 64px; margin-bottom: 1rem; opacity: 0.3;">ğŸ“‹</div>
        <h3 style="font-size: 24px; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">
          No itineraries found
        </h3>
        <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 16px;">
          Start by creating your first itinerary in the RDF triplestore
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <a href="{% url 'itinerary:create' %}?type=Business" class="cta-hero" style="text-decoration: none;">
            ğŸ’¼ Create Business Trip
          </a>
          <a href="{% url 'itinerary:create' %}?type=Leisure" class="cta-hero" style="text-decoration: none;">
            ğŸ–ï¸ Create Leisure Trip
          </a>
          <a href="{% url 'itinerary:create' %}?type=Educational" class="cta-hero" style="text-decoration: none;">
            ğŸ“ Create Educational Trip
          </a>
        </div>
      </div>
    {% endif %}
  </div>
  
  {% include 'core/partials/_footer.html' %}
  <script>
    (function() {
      const btn = document.getElementById('aiRunBtn');
      const input = document.getElementById('aiQueryInput');
      const out = document.getElementById('aiResult');
      const suggestions = document.querySelectorAll('.ai-suggest');

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      async function runQuery() {
        const q = (input.value || '').trim();
        if (!q) {
          out.textContent = 'Please enter a query.';
          return;
        }
        btn.disabled = true;
        btn.textContent = 'Running...';
        out.textContent = '';
        try {
          const csrf = getCookie('csrftoken');
          const form = new URLSearchParams();
          form.set('query', q);
          const resp = await fetch('{% url "itinerary:ai_query" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
              'X-CSRFToken': csrf || ''
            },
            body: form.toString()
          });
          const data = await resp.json();
          // Pretty print minimal info
          if (data.error) {
            out.textContent = 'âŒ ' + data.error + '\n\n' + (data.sparql ? ('SPARQL:\n' + data.sparql) : '');
          } else if (data.mode === 'update') {
            out.textContent = 'âœ… UPDATE executed.\n\nSPARQL:\n' + (data.sparql || '');
            // Refresh the list to reflect CRUD changes
            setTimeout(function() { window.location.reload(); }, 500);
          } else if (data.mode === 'create') {
            out.textContent = 'âœ… CREATED Itinerary: ' + (data.created_id || '') + '\n';
            setTimeout(function() { window.location.reload(); }, 500);
          } else {
            out.textContent = 'âœ… SELECT executed.\n\nSPARQL:\n' + (data.sparql || '') + '\n\nResults:\n' + JSON.stringify(data.results || {}, null, 2);
            // Try to extract IDs from results and refresh list with id_in filter
            try {
              const bindings = (data.results && data.results.results && data.results.results.bindings) || [];
              const ids = [];
              for (const b of bindings) {
                // Prefer variable named 'id'; fallback to last segment of subject URI
                if (b.id && b.id.value) {
                  ids.push(b.id.value);
                } else if (b.s && b.s.value) {
                  const s = b.s.value;
                  let local = s.includes('#') ? s.split('#').pop() : s.split('/').pop();
                  if (local.includes('/')) local = local.split('/').pop();
                  if (local.startsWith('I-')) ids.push(local);
                }
              }
              if (ids.length > 0) {
                const params = new URLSearchParams(window.location.search);
                params.set('id_in', ids.join(','));
                window.location.search = params.toString();
              }
            } catch (e) { /* ignore */ }
          }
        } catch (e) {
          out.textContent = 'âŒ ' + (e && e.message ? e.message : 'Request failed');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Run';
        }
      }

      if (btn) {
        btn.addEventListener('click', runQuery);
      }
      if (suggestions && suggestions.length) {
        suggestions.forEach(function(el) {
          el.addEventListener('click', function() {
            if (!input) return;
            input.value = el.getAttribute('data-q') || '';
            runQuery();
          });
        });
      }
      if (input) {
        input.addEventListener('keydown', function(ev) {
          if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') {
            ev.preventDefault();
            runQuery();
          }
        });
      }
    })();
  </script>
{% endblock %}

{% block styles %}
<style>
  /* Enhanced button hover effects */
  .cta-hero {
    position: relative;
    overflow: hidden;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-radius: var(--radius-full);
    font-weight: 700;
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
    transition: var(--transition);
  }
  
  .cta-hero::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }
  
  .cta-hero:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
  }

  .cta-hero:hover::before {
    left: 100%;
  }

  /* Responsive table */
  @media (max-width: 768px) {
    table {
      font-size: 13px;
    }
    
    th, td {
      padding: 1rem !important;
    }
    
    td > div {
      flex-direction: column;
    }
    
    td > div a {
      width: 100%;
      text-align: center;
    }

    .container > div:first-child {
      flex-direction: column;
      align-items: flex-start;
    }

    .container > div:first-child > div:last-child {
      width: 100%;
      flex-direction: column;
    }

    .cta-hero {
      width: 100%;
      text-align: center;
    }
  }
</style>
{% endblock %}